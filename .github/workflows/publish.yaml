name: Publish

# Controls when the workflow will run
on:
  # Triggers the workflow on push or pull request events but only for the main branch
  push:
    branches: [ main ]

  # Allows you to run this workflow manually from the Actions tab
  workflow_dispatch:

# A workflow run is made up of one or more jobs that can run sequentially or in parallel
jobs:
  # This workflow contains a single job called "build"
  publish:
    # The type of runner that the job will run on
    runs-on: ubuntu-latest

    # Steps represent a sequence of tasks that will be executed as part of the job
    steps:
      # Checks-out your repository under $GITHUB_WORKSPACE, so your job can access it
      - uses: actions/checkout@v2

      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.9'

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install lektor

      # Lektor build will store the build files in a temporary directory for later
      - name: Build with Lektor
        run: lektor build --output-path $RUNNER_TEMP/build

      - name: Setup git config
        run: |
          git config user.name "lektor deploy"
          git config user.email "<>"

      - name: Switch to gh-pages
        uses: actions/checkout@v2
        with:
          ref: gh-pages

      # Gets the built website files from the temporary directory, and the common files (like the readme) from the main
      # branch, and commits them to the gh-pages branch
      - name: Commit build to gh-pages
        run: |
          cp -r $RUNNER_TEMP/build/* .
          git checkout main .gitignore README.md .github/workflows/publish.yaml
          git add *
          git commit -m "Automated commit for deploy"
          git push origin gh-pages
